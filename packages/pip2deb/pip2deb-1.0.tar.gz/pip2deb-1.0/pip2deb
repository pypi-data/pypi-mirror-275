#!/bin/bash

modul="$1"

prefix='/usr/lib/python3.12/dist-packages'

debian="${modul}/DEBIAN"
control="${debian}/control"

if [ "$#" -eq 2 ]; then
        prefix="$2"
fi

target="${prefix}"

build_target="${modul}${target}"

python3 -m venv .venv

source .venv/bin/activate

pip install --no-cache-dir "${modul}"

name=$(pip show "${modul}" | grep "Name: " | awk '{print $2}')
version=$(pip show "${modul}" | grep "Version: " | awk '{print $2}')
description=$(pip show "${modul}" | grep "Summary: " | awk '{print $2}')
maintainer=$(pip show "${modul}" | grep "Author: " | awk '{print $2}')
email=$(pip show "${modul}" | grep "Author-email: " | awk '{print $2}')

mkdir -p "${build_target}"

pip install --no-cache-dir "${modul}" --target "${build_target}"

mkdir -p "${debian}"

cat <<EOF > "${control}"
Package: ${name}
Version: ${version}
Section: utils
Architecture: $(dpkg --print-architecture)
Priority: important
Depends: python3, python3-venv, python3-pip
Maintainer: ${maintainer} <${email}>
Description: ${description}
EOF

chmod 755 "${debian}"

dpkg-deb -b "${modul}"

deactivate

rm -rf .venv

mv "${modul}.deb" "python3-${modul}_v.${version}_$(dpkg --print-architecture).deb"

rm -rf "${modul}"

echo "[*] Build pip modul: ${modul} as Package, successful"


"use strict";(self.webpackChunkpaper_admin=self.webpackChunkpaper_admin||[]).push([[371],{1049:(e,t,s)=>{s.r(t);var n=s(5526),r=s(246);class a{constructor(e){this._buildTree(e)}_createNode(e){const t=e.dataset;return{pk:t.id,parent:t.parent,element:e,childs:[]}}_addNode(e){e&&void 0!==e.pk&&(this._nodes[e.pk]=e,""===e.parent&&this._roots.push(e))}_buildTree(e){const t=[];this._nodes={},this._roots=[],e.forEach((e=>{const s=this._createNode(e);for(this._addNode(s);t.length;){const e=t[0];if(s.parent===e.pk)return e.childs.push(s.pk),void t.unshift(s);t.shift()}t.unshift(s)}))}getNode(e){if(!(e in this._nodes))throw new Error(`node ${e} not found`);return this._nodes[e]}getRoots(){return this._roots.map((e=>e.element))}getDescendants(e){return this.getNode(e).childs.reduce(((e,t)=>{const s=this.getNode(t);return s&&(e.push(s.element),e=e.concat(this.getDescendants(t))),e}),[])}}class o{constructor(e,t){if(this.opts=Object.assign({url:null,tree:!1,handler:".handler",disabledClass:"disabled"},t),this.table=e,this.tbody=e.querySelector("tbody"),!this.tbody)throw new Error("table body not found");this.tree=null,this._createSortable()}_createSortable(){return r.Ay.create(this.tbody,{animation:0,draggable:"tr",handle:this.opts.handler,filter:(e,t,s)=>{if(t.classList.contains(this.opts.disabledClass))return!0;const n=t.querySelector(this.opts.handler);return!(!n||!n.classList.contains(this.opts.disabledClass))||void 0},ghostClass:"sortable-ghost",onStart:this._onStart.bind(this),onMove:this._onMove.bind(this),onEnd:this._onEnd.bind(this)})}_onStart(e){const t=this.tbody.querySelectorAll("tr");if(this.opts.tree){this.tree=new a(t);const s=e.item.dataset.parent;void 0!==s&&t.forEach((e=>{const t=e.dataset.parent;void 0!==t&&t!==s&&e.classList.add(this.opts.disabledClass)}))}}_onMove(e){return!e.related.classList.contains(this.opts.disabledClass)}_onEnd(e){this.tbody.querySelectorAll("tr").forEach((e=>{e.classList.remove(this.opts.disabledClass)}));const t=this._getMovedRows(e);if(!t.length||1===t.length)return;this._normalizeTable(e,t);const s=this._createOrderMap(e,t),n=this.tbody.querySelectorAll(this.opts.handler);n.forEach((e=>{e.classList.add(this.opts.disabledClass)})),this._sendRequest(s).then((()=>{n.forEach((e=>{e.classList.remove(this.opts.disabledClass)}))}))}_getMovedRows(e){const t=Math.min(e.oldIndex,e.newIndex),s=Math.max(e.oldIndex,e.newIndex),n=this.tbody.querySelectorAll("tr");let r=Array.prototype.slice.call(n,t,s+1);if(this.tree){const t=e.item.dataset.id,s=this.tree.getNode(t);r=r.filter((e=>e.dataset.parent===s.parent))}return r}_createOrderMap(e,t){const s=[],n=[];t.forEach((e=>{e.querySelector(this.opts.handler)&&(s.push(e.dataset.id),n.push(parseInt(e.dataset.orderValue)))}));return e.oldIndex<e.newIndex?n.unshift(n.pop()):n.push(n.shift()),s.reduce(((e,t,s)=>{e[t]=n[s];return this.tbody.querySelector(`tr[data-id="${t}"]`).setAttribute("data-order-value",n[s]),e}),{})}_normalizeTable(e,t){if(!this.tree)return;const s=e.item.dataset.id,n=this.tree.getNode(s),r=e.item.previousElementSibling,a=e.item.nextElementSibling,o=t.slice();if(r&&a){const e=r.dataset.parent===n.parent,t=a.dataset.parent===r.dataset.id;e&&t&&!o.includes(r)&&o.unshift(r)}o.forEach((e=>{const t=e.dataset.id,s=this.tree.getDescendants(t);Element.prototype.after.apply(e,s)}))}_sendRequest(e){return fetch(this.opts.url,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then((e=>{if(!e.ok){const t=new Error(`${e.status} ${e.statusText}`);throw t.response=e,t}}))}}var c=s(7137),l=s(177),i=s(1418),d=s(9037);class u extends i.${get Defaults(){return{allowInput:!0,altInput:!0,locale:this._getLocale(),dateFormat:this._getDateFormat(),parseDate:function(e){return new Date(e)}}}constructor(e,t){super(t),this.startElement=e.querySelector("[data-range-start]"),(0,l.xh)(this.startElement,this.options),this.endElement=e.querySelector("[data-range-end]"),(0,l.xh)(this.endElement,this.options),this.on(e,"click",(e=>{const t=e.target.closest("[data-today]");if(t){const e=t.closest(".input-group"),s=e&&e.querySelector("input");s&&s._flatpickr&&s._flatpickr.setDate("today")}}))}destroy(){super.destroy(),this.startElement._flatpickr&&this.startElement._flatpickr.destroy(),this.endElement._flatpickr&&this.endElement._flatpickr.destroy()}_getLocale(){for(const e of(0,d.A)())if(l.xh.l10ns[e])return e;return"default"}_getDateFormat(){for(const e of(0,d.A)())if(l.zg[e])return l.zg[e];return"Y-m-d"}}n.A.register("paper-date-range-filter",{init:function(e){e._dateRangeFilter=new u(e)},destroy:function(e){e._dateRangeFilter&&(e._dateRangeFilter.destroy(),delete e._dateRangeFilter)}}),n.A.register("paper-select2-filter",{init:function(e){e._select2Instance=new c.c(e,{width:"100%",allowClear:!0,containerCssClass:"select2-container--small"})},destroy:function(e){e._select2Instance&&(e._select2Instance.destroy(),delete e._select2Instance)}});const h="action-toggle",p="action-select",f="paper-actions__counter",m="paper-actions__question",g="paper-actions__all",y="paper-actions__clear",_=".paper-actions__select_across input.select-across";function b(e,t){e.forEach((e=>{e&&"TR"===e.tagName&&e.dispatchEvent(new CustomEvent("select",{bubbles:!0,cancelable:!0,detail:{state:t}}))}))}function E(e){const t=e.reduce(((e,t)=>e+(t.checked?1:0)),0);document.querySelectorAll(`.${f}`).forEach((e=>{e.innerHTML=interpolate(ngettext("%(sel)s of %(cnt)s selected","%(sel)s of %(cnt)s selected",t),{sel:t,cnt:e.dataset.actionsIcnt},!0)})),t===e.length?document.querySelectorAll(`.${m}`).forEach((e=>{e.hidden=!1})):S(e)}function v(e){document.querySelectorAll(_).forEach((t=>{t.value=Number(e)}))}function S(e){v(!1);document.querySelectorAll(`.${f}`).forEach((e=>{e.hidden=!1}));document.querySelectorAll(`.${g}`).forEach((e=>{e.hidden=!0}));const t=e.reduce(((e,t)=>e+(t.checked?1:0)),0);document.querySelectorAll(`.${m}`).forEach((s=>{s.hidden=t!==e.length}));document.querySelectorAll(`.${y}`).forEach((e=>{e.hidden=!0}))}const k=document.querySelectorAll(`.${p}`);k.length&&function(e){let t=null;const s=document.getElementById("result_list"),n=document.getElementById(h);n.addEventListener("change",(()=>{const t=e.map((e=>e.closest("tr")));b(t,n.checked),E(e)})),s.addEventListener("select",(t=>{const r=t.target;if("TR"!==r.tagName||r.closest("table")!==s)return;const a=Boolean(t.detail.state);r.querySelector(`.${p}`).checked=a,r.classList.toggle("selected",a),n.checked=null==e.find((e=>!e.checked))})),s.addEventListener("click",(s=>{const n=s.target,r=n.closest("tr");if(!r)return;const a=n.closest(".action-checkbox .custom-control"),o=r.querySelector(`.${p}`);if(s.shiftKey&&t){const s=e.indexOf(t),n=e.indexOf(o),r=Math.min(s,n),a=Math.max(s,n),c=e.slice(r,a+1).map((e=>e.closest("tr")));b(c,t.checked)}else(a||s.ctrlKey&&!s.shiftKey)&&(t=o,b([r],!o.checked));E(e)})),s.addEventListener("mousedown",(e=>{const t=e.target;!e.shiftKey||"TD"!==t.tagName&&"TH"!==t.tagName||e.preventDefault()})),document.addEventListener("click",(e=>{const t=e.target;"A"===t.tagName&&t.closest(`.${m}`)&&(e.preventDefault(),v(!0),document.querySelectorAll(`.${f}`).forEach((e=>{e.hidden=!0})),document.querySelectorAll(`.${g}`).forEach((e=>{e.hidden=!1})),document.querySelectorAll(`.${m}`).forEach((e=>{e.hidden=!0})),document.querySelectorAll(`.${y}`).forEach((e=>{e.hidden=!1})))})),document.addEventListener("click",(t=>{const s=t.target;if("A"===s.tagName&&s.closest(`.${y}`)){t.preventDefault(),n.checked=!1;const s=e.map((e=>e.closest("tr")));b(s,!1),S(e),E(e)}})),function(){let e=!1;document.getElementById("changelist-form").addEventListener("change",(t=>{const s=t.target;"INPUT"===s.tagName?s.closest(`.${p}`)||s.id===h||(e=!0):"SELECT"===s.tagName&&s.closest(".action-action")||(e=!0)})),document.addEventListener("click",(t=>{t.target.closest('[name="index"]')&&e&&(confirm(gettext("You have unsaved changes on individual editable fields. If you run an action, your unsaved changes will be lost."))||t.preventDefault())})),document.addEventListener("click",(t=>{const s=t.target.closest('[name="_save"]'),n=document.querySelectorAll('.actions select[name="action"]'),r=!Array.prototype.every.call(n,(e=>!e.value));if(s&&r){let s;s=e?confirm(gettext("You have selected an action, but you haven't saved your changes to individual fields yet. Please click OK to save. You'll need to re-run the action.")):confirm(gettext("You have selected an action, and you haven't made any changes on individual fields. You're probably looking for the Go button rather than the Save button.")),s||t.preventDefault()}}))}()}(Array.from(k)),window.addEventListener("keydown",(e=>{if(!e.defaultPrevented&&e.ctrlKey){const t=document.querySelector(".paper-pagination");if(!t)return;switch(e.key){case"Left":case"ArrowLeft":t.querySelector('.page-link[aria-label="Previous"]').click();break;case"Right":case"ArrowRight":t.querySelector('.page-link[aria-label="Next"]').click();break;default:return}e.preventDefault()}}));const A=document.querySelector(".paper-search-form"),q=A&&A.querySelector(".form-control");q&&q.addEventListener("focus",(()=>{q.select()})),n.A.register("paper-actions",{init:function(e){e._paperActions=new c.c(e,{allowClear:!0,containerCssClass:"select2-container--small",minimumResultsForSearch:1/0})},destroy:function(e){e._paperActions&&(e._paperActions.destroy(),delete e._paperActions)}});const w=document.getElementById("result_list");w&&w.classList.contains("paper-table--sortable")&&new o(w,{url:w.dataset.orderUrl,tree:w.classList.contains("paper-table--tree"),handler:".paper-table__sort-handler"})}}]);
//# sourceMappingURL=changelist.a91de481d6f691b4bbce.js.map
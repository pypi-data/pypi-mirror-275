{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "fef81e1f",
   "metadata": {},
   "source": [
    "# configurator report\n",
    " This notebook contains the automatic `configurator` report based on preliminary PE results.\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "606c7795",
   "metadata": {},
   "source": [
    "\n",
    "**Data provenance**\n",
    "\n",
    "|  |  |\n",
    "|--|--|\n",
    "| PE summary file | /Users/hestelles/Downloads/posterior_samples-GW191109_final.h5 |\n",
    "|  Data set       |  SEOBNRv5PHM     |\n",
    "| md5sum of file      |     72ce4d48c94994e0c7a042d9c04339b4     |\n",
    "| git revision of data | N/A__DIRTY | \n",
    "\n",
    "**Settings**\n",
    "\n",
    "| | |\n",
    "|--|--|\n",
    "|$f_{\\rm low}$|20.0 Hz|\n",
    "|$f_{\\rm ref}$|20.0 Hz|\n",
    "|Max $\\ell$ for Nyquist check|3|\n",
    "|Tolerance for railing|2.0|\n",
    "|nbins for railing|50|\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fa4df7f3",
   "metadata": {},
   "outputs": [],
   "source": [
    "%matplotlib inline\n",
    "import pesummary\n",
    "from pesummary.io import read\n",
    "import numpy as np\n",
    "import matplotlib.pyplot as plt\n",
    "import pandas as pd\n",
    "%config InlineBackend.figure_format = 'retina'\n",
    "import warnings\n",
    "warnings.filterwarnings('ignore')"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d197cdb1",
   "metadata": {},
   "source": [
    "## Automatically generated analysis"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "fef4493e",
   "metadata": {},
   "source": [
    "\n",
    "* **Equal masses are excluded at high confidence for this event!\n",
    "**\n",
    "\n",
    "\n",
    "* **The median $\\chi_{\r",
    "m eff}<0.1$!\n",
    "The median $\\chi_{p}>0.6$, highly precessing event?**\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "752c3894",
   "metadata": {},
   "outputs": [],
   "source": [
    "file_name = '/Users/hestelles/Downloads/posterior_samples-GW191109_final.h5'\n",
    "data = read(file_name)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bed2cea7",
   "metadata": {},
   "outputs": [],
   "source": [
    "samples_dict = data.samples_dict\n",
    "posterior_samples = samples_dict['SEOBNRv5PHM']\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d1515923",
   "metadata": {},
   "source": [
    "## Summary of posterior sample parameters\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "bc62e821",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "mtot = np.array(posterior_samples[\"total_mass\"])\n",
    "q = np.array(posterior_samples[\"mass_ratio\"])\n",
    "chi1z = np.array(posterior_samples[\"spin_1z\"])\n",
    "chi2z = np.array(posterior_samples[\"spin_2z\"])\n",
    "dist = np.array(posterior_samples[\"luminosity_distance\"])\n",
    "chirp_mass = np.array(posterior_samples[\"chirp_mass\"])\n",
    "\n",
    "dc = {\n",
    "    r\"$\\mathcal{M}$\": chirp_mass,\n",
    "    r\"$M_{\\rm total}$\": mtot,\n",
    "    r\"$q$\": q,\n",
    "    r\"$d_{L}$\": dist,\n",
    "    r\"$\\chi_{1z}$\": chi1z,\n",
    "    r\"$\\chi_{2z}$\": chi2z\n",
    "}\n",
    "df = pd.DataFrame(dc)\n",
    "try:\n",
    "    from pandas_profiling import ProfileReport\n",
    "    have_report = True\n",
    "except:\n",
    "    from IPython.core.display import display, HTML\n",
    "    have_report = False\n",
    "\n",
    "have_report = False\n",
    "if have_report:\n",
    "    profile = ProfileReport(df, title='Pandas Profiling Report',minimal=True,progress_bar=False,\n",
    "        html={\"navbar_show\": False})\n",
    "    profile.to_widgets()\n",
    "else:\n",
    "    from IPython.core.display import display, HTML\n",
    "    display(HTML(df.describe().to_html()))\n",
    "    "
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1a92ec87",
   "metadata": {},
   "source": [
    "## Posterior railing visual check"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9f5289a6",
   "metadata": {},
   "source": [
    "Automatic checks on railing. Note that the **recommendations are ad-hoc** and may not result in posteriors not being cut off."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "bc73d385",
   "metadata": {},
   "source": [
    "\n",
    "| |  | Recommendation  |\n",
    "|--|--|--|\n",
    "|chirp_mass|**<font color='green'>PASSED</font>**| | \n",
    "|distance|**<font color='green'>PASSED</font>**| | \n",
    "|mass_ratio|**<font color='green'>PASSED</font>**| | \n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a74a1005",
   "metadata": {},
   "source": [
    "Plot of selected posterior parameters. **All masses are in the detector frame**.  The red dashed lines show the proposed $\\mathcal{M}$ bounds,[30.1513,85.9052]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "15d7bd7f",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "checks_passed = False\n",
    "version = [int(x) for x in pd.__version__.split('.')]\n",
    "if version[0]<1:\n",
    "    j,k = 1,0\n",
    "else:\n",
    "    j,k = 0,0\n",
    "\n",
    "N = len(df.columns)\n",
    "if N%3 == 0:\n",
    "    n = N//3\n",
    "else:\n",
    "    n = np.floor(N/3)+1\n",
    "\n",
    "plt.rcParams['axes.titlesize'] =  'xx-large'   \n",
    "plt.rcParams['font.size'] = 18\n",
    "plt.rcParams['text.usetex'] = False\n",
    "axes=df.hist(figsize=(12,8),bins=50,layout=(n,3),histtype=\"step\",density=True)\n",
    "if checks_passed:\n",
    "    axes[j,k].axvline(x=30.151299518817993, ls=\"--\", color=\"r\")\n",
    "    axes[j,k].axvline(x=85.90523305909169, ls=\"--\", color=\"r\")\n",
    "    _ = axes[j,k].set_xlim(0.95 * 30.151299518817993,1.05 * 85.90523305909169)\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "09c80e4f",
   "metadata": {},
   "source": [
    "## MECO frequency check\n",
    " The reference frequency is shown as a dashed green vertical line. If the reference frequency has been modified by the MECO test, the input value appears in red and the new value in green."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "12f51e04",
   "metadata": {},
   "source": [
    "\n",
    "| |  | Recommendation  |\n",
    "|--|--|--|\n",
    "|f_ref|**<font color='red'>FAILED. f_ref has been overwritten to a safe value.</font>**| | \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c53079c3",
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "import lalsimulation as LS\n",
    "\n",
    "def MECO_freq(m_total, q, chi1z, chi2z):\n",
    "    eta = q / (1.0 + q) ** 2\n",
    "    fmeco_tmp = LS.SimIMRPhenomXfMECO(eta, chi1z, chi2z)\n",
    "    fmeco = LS.SimIMRPhenomXUtilsMftoHz(fmeco_tmp, m_total)\n",
    "    return fmeco\n",
    "\n",
    "f_ref_input = 20.0\n",
    "f_ref = 14.861333362491681\n",
    "f_MECOs = np.array([\n",
    "        MECO_freq(mt, 1 / qp, s1z, s2z)\n",
    "        for mt, qp, s1z, s2z in list(zip(mtot, q, chi1z, chi2z))\n",
    "    ])\n",
    "plt.figure(figsize=(8,6))\n",
    "plt.hist(f_MECOs,bins=50,histtype=\"step\",density=True)\n",
    "plt.axvline(f_ref_input,ls=\"--\",color=\"r\")\n",
    "plt.axvline(f_ref,ls=\"--\",color=\"g\")\n",
    "plt.xlabel(r\"$f_{\\rm MECO}$ (Hz)\")\n",
    "_ = plt.ylabel(r\"Probability density\")\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0e6ef37f",
   "metadata": {},
   "source": [
    "## Recommended settings"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c472fe84",
   "metadata": {},
   "source": [
    "\n",
    "|  |  |\n",
    "|--|--|\n",
    "|  seglen | 4.0 sec. |\n",
    "|  srate       |  1024     |\n",
    "|  $f_{\\rm start}$     | 8.945 Hz|\n",
    "|  $f_{\\rm ref}$     | 14.8613 Hz|\n",
    "| $\\mathcal{M}$ bounds | [30.1513,85.9052]|\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1ceb3444",
   "metadata": {},
   "source": [
    "## Extra information"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2cba52ec",
   "metadata": {},
   "source": [
    "\n",
    "|  |  |\n",
    "|--|--|\n",
    "|Date| 2023-04-12 09:47:48.056008|\n",
    "|Script revision| ad853bac7cca41f13b704b059414ff09d8157603__DIRTY|\n",
    "|Complete arguments | Namespace(output_dir='examples/test_GW191109', HM=True, q_min=None, ell_max=3, tolerance=2.0, nbins=50, flow=20.0, f_ref=20.0, bounds_tol=0.2, json_file='test.json', report_file='test.pdf', override_safeties=False, debug=False, include_dL_recommendations=False)|\n"
   ]
  }
 ],
 "metadata": {},
 "nbformat": 4,
 "nbformat_minor": 5
}

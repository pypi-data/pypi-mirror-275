#!/bin/bash

if ! command -v bash >/dev/null 2>&1; then
    echo "Bash not found. Exiting."
    exit 1
fi

{% block shared_functions %}
run_install_commands () {
    echo "install..."
    gcloud config set core/project {{ service.environment.collection.account_id }}
}

run_pre_build_commands () {
    echo `gcloud --version`
}

send_{{ service.name }}_status_hook () {
    echo -e \\nSending coherence build status webhook...\\n

    which curl; curl_exists=$?
    if [ $curl_exists -ne 0 ]; then
        echo -e \\nWarning: Cannot find curl binary, skipping coherence build status webhook...\\n
    else
        build_status=${1:-$COHERENCE_BUILD_STATUS}
        coherence_build_status=${build_status:-failed}
        curl -X PUT -H "Content-Type: application/json" \
        -d '{"token": "{{ stage.provider_token }}", "status": "'"$coherence_build_status"'"}' \
        {{ stage.callback_url }}; webhook_status=$?

        if [ $webhook_status -ne 0 ]; then
            echo -e \\nBuild status webhook failed.
            exit 0
        else
            echo -e \\nBuild status webhook succeeded.
        fi
    fi
}
{% endblock %}

{% block render_functions %}
{{ render_template("all-access-policy.yml.j2", "policy-all-{}.yml".format(service.name)) }}
{{ render_template("run-svc.yml.j2", "run-{}.yml".format(service.name)) }}
{{ render_template("run-job.yml.j2", "job-{}.yml".format(service.name)) }}

{% if service.is_backend %}

{% if service.settings.workers %}
{{ render_template("k8s/workers.yml", "{}-workers.yml".format(service.name)) }}
{% endif %}

{% if service.settings.scheduled_tasks %}
{{ render_template("k8s/scheduled_tasks.yml", "{}-tasks.yml".format(service.name)) }}
{% endif %}

{% endif %}

{% endblock %}

{% block deploy_functions %}

{% block backend_functions scoped %}
{% if service.is_backend %}
{% block migrate_function scoped %}
{% if service.settings.migrate %}
migrate_{{ service.name }} () {
    cnc toolbox run {{ environment.name }} --tag {{ deployer.tag_for_service(service.name) }} \
    --service-name {{ service.name }} -- '{{ " ".join(service.settings.migrate) }}'; migrate_result=$?
    if [ $migrate_result -ne 0 ]; then exit $migrate_result; fi
}
{% endif %}
{% endblock %}

{% block seed_function scoped %}
{% if service.settings.seed %}
seed_{{ service.name }} () {
    cnc toolbox run {{ environment.name }} --tag {{ deployer.tag_for_service(service.name) }} \
    --service-name {{ service.name }} -- '{{ " ".join(service.settings.seed) }}'; seed_result=$?
    if [ $seed_result -ne 0 ]; then exit $seed_result; fi
}
{% endif %}
{% endblock %}

{% if service.settings.workers %}
deploy_{{ service.name }}_workers () {
    gcloud container clusters get-credentials --region {{ environment.collection.region }} {{ environment.collection.instance_name }}
    kubectl apply -f {{ deployer.rendered_files_path }}/{{ service.name }}-workers.yml
}
{% endif %}

{% if service.settings.scheduled_tasks %}
deploy_{{ service.name }}_tasks () {
    gcloud container clusters get-credentials --region {{ environment.collection.region }} {{ environment.collection.instance_name }}

    # solve a race condition in creating some common resources with workers
    sleep 5

    kubectl apply -f {{ deployer.rendered_files_path }}/{{ service.name }}-tasks.yml
}
{% endif %}

deploy_{{ service.name }} () {
    gcloud run services replace {{ deployer.rendered_files_path }}/run-{{ service.name }}.yml
    gcloud run services describe {{ service.instance_name }} --region {{ service.environment.collection.region }}
    gcloud run services set-iam-policy {{ service.instance_name }} {{ deployer.rendered_files_path }}/policy-all-{{ service.name }}.yml --region {{ service.environment.collection.region }} --quiet

    gcloud run jobs replace {{ deployer.rendered_files_path }}/job-{{ service.name }}.yml --region {{ service.environment.collection.region }}
    gcloud run jobs describe {{ service.instance_name }} --region {{ service.environment.collection.region }}
}

{% endif %}
{% endblock %}

{% block frontend_functions scoped %}
{% if service.is_frontend %}
deploy_{{ service.name }} () {
    gcloud run services replace {{ deployer.rendered_files_path }}/run-{{ service.name }}.yml
    gcloud run services describe {{ service.instance_name }} --region {{ service.environment.collection.region }}
    gcloud run services set-iam-policy {{ service.instance_name }} {{ deployer.rendered_files_path }}/policy-all-{{ service.name }}.yml --region {{ service.environment.collection.region }}
}
{% endif %}
{% endblock %}

{% endblock %}

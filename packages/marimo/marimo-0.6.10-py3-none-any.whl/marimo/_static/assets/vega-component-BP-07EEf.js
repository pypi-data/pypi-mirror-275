import{g7 as e,u as n,j as t,aE as r,r as i,g8 as a,Q as o,bW as c,g9 as s,ga as l,aW as m,Y as u,X as p}from"./index-CJA8CbVP.js";import{M as d,V as f}from"./VegaLite-DzIWSg5G.js";import"./time-DgM3ZAP8.js";import"./timer-D8GWrtRJ.js";import"./linear-x0yx5cNT.js";import"./init-DLRA0X12.js";import"./range-CtcPcB_L.js";import"./index-tYOaxszt.js";import"./ordinal-DDUp3AbE.js";import"./arc-DIImc9ZO.js";import"./path-qnb_ma6O.js";import"./step-BEJ6WznM.js";import"./array-DmjLdZ15.js";import"./line-Dz7yhIWK.js";const g={getMarkType(e){const n="string"==typeof e?e:e.type;if("boxplot"===n||"errorband"===n||"errorbar"===n)throw new Error("Not supported");return n},makeClickable(e){const n="string"==typeof e?e:e.type;return n in d?"string"==typeof e?{type:e,cursor:"pointer",tooltip:!0}:{...e,type:n,cursor:"pointer",tooltip:!0}:e},getOpacity:e=>"string"==typeof e?null:"opacity"in e&&"number"==typeof e.opacity?e.opacity:null};const v=new Set(["color","fill","fillOpacity","opacity","shape","size"]);function y(e,n,t,r){const i={and:t.map((e=>({param:e})))};if("opacity"===e){const e=g.getOpacity(r)||1;return{...n,opacity:{condition:{test:i,value:e},value:e/5}}}return n}const h={point:e=>null==e?"select_point":`select_point_${e}`,interval:e=>null==e?"select_interval":`select_interval_${e}`,legendSelection:e=>`legend_selection_${e}`,HIGHLIGHT:"highlight"},k={highlight:()=>({name:h.HIGHLIGHT,select:{type:"point",on:"mouseover"}}),interval:(e,n)=>({name:h.interval(n),select:{type:"interval",encodings:b(e),mark:{fill:"#669EFF",fillOpacity:.07,stroke:"#669EFF",strokeOpacity:.4}}}),point:(e,n)=>({name:h.point(n),select:{type:"point",encodings:b(e)}}),legend:e=>({name:h.legendSelection(e),select:{type:"point",fields:[e]},bind:"legend"})};function b(e){switch(g.getMarkType(e.mark)){case d.image:case d.trail:return;case d.area:case d.arc:return["color"];case d.bar:{const n=function(e){var n,t;if(!e||!("mark"in e))return;const r=null==(n=e.encoding)?void 0:n.x,i=null==(t=e.encoding)?void 0:t.y;if(r&&"type"in r&&"nominal"===r.type)return"vertical";if(i&&"type"in i&&"nominal"===i.type)return"horizontal";if(r&&"aggregate"in r)return"horizontal";if(i&&"aggregate"in i)return"vertical";return}(e);return"horizontal"===n?["y"]:"vertical"===n?["x"]:void 0}case d.circle:case d.geoshape:case d.line:case d.point:case d.rect:case d.rule:case d.square:case d.text:case d.tick:return["x","y"]}}function x(e){if("params"in e&&e.params&&e.params.length>0){return e.params.filter((e=>null!=e&&("select"in e&&void 0!==e.select))).map((e=>e.name))}return"layer"in e?[...new Set(e.layer.flatMap(x))]:[]}function j(e,n){const{chartSelection:t=!0,fieldSelection:r=!0}=n;if(!t&&!r)return e;if("vconcat"in e){const n=e.vconcat.map((e=>"mark"in e?w(e):e));return{...e,vconcat:n}}if("hconcat"in e){const n=e.hconcat.map((e=>"mark"in e?w(e):e));return{...e,hconcat:n}}if("layer"in e){const n=e.layer.map(((e,n)=>{if(!("mark"in e))return e;let r=e;return r=N(r,t,n),r=w(r),r}));return{...e,layer:n}}if(!("mark"in e))return e;let i=e;return i=function(e,n){if(!1===n)return e;let t=function(e){if(!e||!("encoding"in e))return[];const{encoding:n}=e;return n?Object.entries(n).flatMap((e=>{const[n,t]=e;return t&&v.has(n)?"field"in t&&"string"==typeof t.field?[t.field]:"condition"in t&&t.condition&&"object"==typeof t.condition&&"field"in t.condition&&t.condition.field&&"string"==typeof t.condition.field?[t.condition.field]:[]:[]})):[]}(e);Array.isArray(n)&&(t=t.filter((e=>n.includes(e))));const r=t.map((e=>k.legend(e))),i=[...e.params||[],...r];return{...e,params:i}}(i,r),i=N(i,t,void 0),i=w(i),i}function N(e,n,t){if(!1===n)return e;let r;try{r=g.getMarkType(e.mark)}catch{return e}if("text"===r)return e;const i=!0===n?function(e){switch(e){case"text":case"arc":case"area":return["point"];case"bar":default:return["point","interval"];case"line":return}}(r):[n];if(!i)return e;const a=i.map((n=>"interval"===n?k.interval(e,t):k.point(e,t))),o=[...e.params||[],...a];return{...e,params:o}}function w(e){const n="encoding"in e?e.encoding:void 0,t=e.params||[],r=t.map((e=>e.name));if(0===t.length)return e;return"text"===g.getMarkType(e.mark)?e:{...e,mark:g.makeClickable(e.mark),encoding:y("opacity",n||{},r,e.mark)}}function S(e){return e.startsWith("./")?new URL(e.slice(1),document.baseURI):(e.startsWith("/"),new URL(e,document.baseURI))}const V=({value:r,setValue:i,chartSelection:a,fieldSelection:o,spec:c})=>{const{data:s}=n((async()=>async function(n){if(!n)return n;const t="datasets"in n?{...n.datasets}:{},r=async n=>{if(!n)return n;if("layer"in n){const e=await Promise.all(n.layer.map(r));n={...n,layer:e}}if("hconcat"in n){const e=await Promise.all(n.hconcat.map(r));n={...n,hconcat:e}}if("vconcat"in n){const e=await Promise.all(n.vconcat.map(r));n={...n,vconcat:e}}if(!n.data)return n;if(!("url"in n.data))return n;let i;try{i=S(n.data.url)}catch{return n}const a=await e(i.href,n.data.format);return t[i.pathname]=a,{...n,data:{name:i.pathname}}},i=await r(n);return 0===Object.keys(t).length?i:{...i,datasets:t}}(c)),[c]);return s?t.jsxDEV(E,{value:r,setValue:i,chartSelection:a,fieldSelection:o,spec:s},void 0,!1,{fileName:"/home/runner/work/marimo/marimo/frontend/src/plugins/impl/vega/vega-component.tsx",lineNumber:65,columnNumber:5},void 0):null},E=({value:e,setValue:n,chartSelection:d,fieldSelection:g,spec:v})=>{const{theme:y}=r(),h=i.useRef(),[k,b]=i.useState(),N=i.useMemo((()=>j(function(e){return e.data&&"url"in e.data&&(e.data.url=S(e.data.url).href),e}(v),{chartSelection:d,fieldSelection:g})),[a(v),d,g]),w=i.useMemo((()=>x(N)),[N]),V=o((t=>{n({...e,...t})})),E=i.useMemo((()=>w.reduce(((e,n)=>(e[n]=c(((e,n)=>{u.debug("[Vega signal]",e,n),V({[e]:p.mapValues(n,_)})}),100),e)),{})),[a(w),n]),D=o((e=>{u.error(e),u.debug(N),b(e)})),O=o((e=>{u.debug("[Vega view] created",e),h.current=e,b(void 0)}));return t.jsxDEV(t.Fragment,{children:[k&&t.jsxDEV(s,{variant:"destructive",children:[t.jsxDEV(l,{children:k.message},void 0,!1,{fileName:"/home/runner/work/marimo/marimo/frontend/src/plugins/impl/vega/vega-component.tsx",lineNumber:151,columnNumber:11},void 0),t.jsxDEV("div",{className:"text-md",children:k.stack},void 0,!1,{fileName:"/home/runner/work/marimo/marimo/frontend/src/plugins/impl/vega/vega-component.tsx",lineNumber:152,columnNumber:11},void 0)]},void 0,!0,{fileName:"/home/runner/work/marimo/marimo/frontend/src/plugins/impl/vega/vega-component.tsx",lineNumber:150,columnNumber:9},void 0),t.jsxDEV("div",{className:"contents",onPointerDown:m.stopPropagation(),children:t.jsxDEV(f,{spec:N,theme:"dark"===y?"dark":void 0,actions:M,signalListeners:E,onError:D,onNewView:O},void 0,!1,{fileName:"/home/runner/work/marimo/marimo/frontend/src/plugins/impl/vega/vega-component.tsx",lineNumber:160,columnNumber:9},void 0)},void 0,!1,{fileName:"/home/runner/work/marimo/marimo/frontend/src/plugins/impl/vega/vega-component.tsx",lineNumber:155,columnNumber:7},void 0)]},void 0,!0,{fileName:"/home/runner/work/marimo/marimo/frontend/src/plugins/impl/vega/vega-component.tsx",lineNumber:148,columnNumber:5},void 0)},M={source:!1,compiled:!1};function _(e){return e instanceof Set?[...e]:e}export{V as default};

var cone_tokens=function(t,e,s){"use strict";class n{static initialize(t){e(".token",t).each((function(){new n(e(this))}))}constructor(t){this.elem=t,this.settings=t.data("token-settings");const s=this;e(".btn-group.timeranges button",t).each((function(){const t=e(this);t.on("click",(function(e){s.set_timerange(t.data("timerange-scope"))}))})),e(".btn-group.usage-count button",t).each((function(){const t=e(this);t.on("click",(function(e){s.set_usage_count(t.data("usage-count"))}))}))}request_api(t){const e=this.settings;s.http_request({url:`${e.base_url}/update_token`,params:t,type:"json",method:"POST",success:(t,n,i)=>{t.success?s.ajax.action({name:"content",selector:"#content",mode:"inner",url:`${e.base_url}`,params:{}}):s.show_error(t.message)},error:(t,e,n)=>{s.show_error(`Failed to request JSON API: ${n}`)}})}set_timerange(t){const e=this.settings.timeranges;let s,n,i;if(Object.keys(e).includes(t)){s=e[t];let o=s.start.split(":");n=new Date,n.setHours(o[0],o[1],0);let a=s.end.split(":");i=new Date,i.setHours(a[0],a[1],0)}function o(t){return t&&(t=new Date(t.getTime()-6e4*t.getTimezoneOffset())),t?t.toISOString():""}this.request_api({valid_from:o(n),valid_to:o(i)})}set_usage_count(t){this.request_api({usage_count:t})}}class i{static initialize(t){e(".tokens-overview-container",t).each((function(){new i(e(this))}))}constructor(t){this.container=t,this.tokens_elem=e("#tokens-overview",t),this.tokens=e("object.token_qr",this.tokens_elem),this.tokens_title=e("#tokens-overview-title",t),this.token_settings=this.container.data("token-settings"),this.add_tokens_container=e(".add-tokens",this.tokens_title),this.add_tokens_input=e('input[name="amount"]',this.add_tokens_container),this.add_tokens_btn=e('button[name="add-tokens"]',this.add_tokens_container),this.add_tokens=this.add_tokens.bind(this),this.add_tokens_btn.on("click",this.add_tokens),this.start=e('input[name="start"]',this.tokens_title).addClass("datepicker").data("date-locale","de"),this.end=e('input[name="end"]',this.tokens_title).addClass("datepicker").data("date-locale","de"),this.filter=e('button[name="filter"]',this.tokens_title),this.filter_tokens=this.filter_tokens.bind(this),this.filter.on("click",this.filter_tokens),this.delete_tokens_container=e(".delete-tokens",this.tokens_title),this.delete_tokens_btn=e('button[name="delete-tokens"]',this.delete_tokens_container),this.delete_tokens=this.delete_tokens.bind(this),this.delete_tokens_btn.on("click",this.delete_tokens),this.set_token_size=this.set_token_size.bind(this),this.size_input=e('input[name="token-size"]',this.tokens_title),this.size_input.on("change",this.set_token_size),this.tokens.length?this.original_size=parseInt(e(this.tokens[0]).attr("width")):this.original_size=256,this.token_size=100}get token_size(){return this._token_size}set token_size(t){t||(t=100);let s=this.original_size*(t/100);this.tokens_elem.css("grid-template-columns",`repeat( auto-fit, minmax(${s}px, 1fr) )`),this.tokens.each((function(){let t=e(this);t.attr("width",`${s}px`),t.attr("height",`${s}px`)})),this.size_input.val()||this.size_input.val(t),this._token_size=t}filter_tokens(t){t.preventDefault();let e={start:this.start.val(),end:this.end.val()};s.ajax.action({name:"tokens_overview",mode:"inner",selector:"#content",url:this.token_settings.base_url,params:e})}add_tokens(t){const e=this.token_settings.base_url;let n=this.add_tokens_input.val();n&&(n=parseInt(n),function t(n,i){s.http_request({url:`${e}/add_token`,params:{},type:"json",method:"POST",success:(o,a,r)=>{o.success?n===(i+=1)?s.ajax.action({name:"tokens_overview",selector:"#content",mode:"inner",url:e,params:{}}):t(n,i):s.show_error(o.message)},error:(t,e,n)=>{s.show_error(`Failed to request JSON API: ${n}`)}})}(n,0))}delete_tokens(t){const n=this.token_settings.base_url;s.show_dialog({title:"Delete tokens?",message:"Do you really want to delete selected tokens?",on_confirm:()=>{let t=[];for(let s of this.tokens){let n=e(s).data("token-uid");t.push(n)}s.http_request({url:`${n}/delete_tokens`,params:{token_uids:JSON.stringify(t)},type:"json",method:"POST",success:(t,e,i)=>{t.success?(s.ajax.action({name:"tokens_overview",selector:"#content",mode:"inner",url:n,params:{}}),s.show_message({message:t.message,flavor:""})):s.show_error(t.message)},error:(t,e,n)=>{s.show_error(`Failed to request JSON API: ${n}`)}})}})}set_token_size(t){t.preventDefault();let e=this.size_input.val();this.token_size=e}}class o{static initialize(t){e(".tokens-container",t).each((function(){new o(e(this))}))}constructor(t){this.elem=t,this.base_url=t.data("base-url"),this.button=e(".scan-token",t),this._input_wrapper=null,this._input=null,this.scan_token=this.scan_token.bind(this),this.button.on("click",(t=>{this.scan_token()}))}get active(){return null!==this._input}set active(t){if(t==this.value)return;let s=this.button;if(t){let t=this._input_wrapper=e("<div/>").css("width",0).css("overflow","hidden"),n=this._input=e('<input type="text">');t.append(n),this.elem.append(t),s.removeClass("inactive").addClass("active"),n[0].focus()}else this._input_wrapper.remove(),this._input_wrapper=null,this._input=null,s.removeClass("active").addClass("inactive")}scan_token(){this.active=!0;let t=this._input;t.one("change",(()=>{this.query_token(t.val())}))}load_token(t){console.log("load token: "+t),s.ajax.action({name:"layout",selector:"#layout",mode:"replace",url:`${this.base_url}/${t}`,params:{}})}query_token(t){s.http_request({url:`${this.base_url}/query_token`,params:{value:t},type:"json",success:(e,n,i)=>{e.success?e.token?this.load_token(e.token.uid):(this.active=!1,s.show_dialog({title:"Token not exists?",message:"Do you want to create it?",on_confirm:()=>{s.http_request({url:`${this.base_url}/add_token`,params:{value:t},type:"json",method:"POST",success:(t,e,n)=>{t.success?this.load_token(t.token_uid):s.show_error(t.message)},error:(t,e,n)=>{s.show_error(`Failed to request JSON API: ${n}`)}})}})):s.show_error(e.message)},error:(t,e,n)=>{s.show_error(`Failed to request JSON API: ${n}`)}})}}return e((function(){s.ajax.register(n.initialize,!0),s.ajax.register(o.initialize,!0),s.ajax.register(i.initialize,!0)})),t.TokenScanner=o,t.TokensOverview=i,Object.defineProperty(t,"__esModule",{value:!0}),t}({},jQuery,ts);
